<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»å‹•å ±å‘Šç”Ÿæˆå™¨ V14.0</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>

    <style>
        body { background-color: #f0f2f5; font-family: "Microsoft JhengHei", sans-serif; }
        .container { max-width: 950px; }
        
        /* UI Components */
        .card { border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; border-radius: 8px; }
        .card-header { background-color: #fff; border-bottom: 2px solid #f0f0f0; font-weight: bold; color: #0d6efd; border-radius: 8px 8px 0 0 !important; }
        .upload-zone { border: 2px dashed #adb5bd; background-color: #e9ecef; padding: 25px; text-align: center; border-radius: 10px; cursor: pointer; transition: 0.3s; }
        .upload-zone:hover { background-color: #dee2e6; border-color: #0d6efd; }
        .upload-zone.active { background-color: #d1e7dd; border-color: #198754; }
        
        .dynamic-card { border-left: 4px solid #0d6efd; background: #fff; padding: 15px; margin-bottom: 10px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .manual-inputs { display: none; background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px; }
        .custom-option-row { display: flex; gap: 5px; margin-bottom: 5px; }

        /* Report Output */
        .report-section { display: none; background: white; padding: 50px; margin-top: 20px; border: 1px solid #ddd; }
        .chart-row { display: flex; align-items: center; page-break-inside: avoid; margin-bottom: 15px; border-bottom: 1px dashed #eee; padding-bottom: 15px; }
        .chart-col { width: 60%; min-width: 350px; }
        .table-col { width: 40%; padding-left: 20px; }
        .chart-container { height: 220px; width: 100%; }
        
        .stats-table { width: 100%; font-size: 0.8rem; border-collapse: collapse; } 
        .stats-table th, .stats-table td { border: 1px solid #dee2e6; padding: 4px; text-align: center; }
        .stats-table th { background-color: #f8f9fa; }

        .fin-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 0.9rem; }
        .fin-table th, .fin-table td { border: 1px solid #dee2e6; padding: 8px; }
        .fin-table th { background-color: #f8f9fa; text-align: center; }
        .fin-amount { text-align: right; font-family: 'Courier New', monospace; }
        .fin-total-row { font-weight: bold; background-color: #e9ecef; }

        .photo-preview { width: 150px; height: 150px; object-fit: cover; margin: 5px; border: 1px solid #ddd; }

        .signature-box { margin-top: 50px; page-break-inside: avoid; font-size: 1.0rem; }
        .sig-line { border-bottom: 1px solid #000; display: inline-block; width: 280px; }
        .sig-row { display: flex; justify-content: space-between; margin-bottom: 40px; align-items: flex-end; }
        .comment-lines { border-bottom: 1px solid #ccc; height: 30px; margin-bottom: 10px; width: 100%; }
        .sig-label { font-weight: bold; min-width: 130px; display: inline-block; }

        @media print {
            @page { margin: 10mm 15mm; }
            body * { visibility: hidden; }
            #reportOutput, #reportOutput * { visibility: visible; }
            #reportOutput { position: absolute; left: 0; top: 0; width: 100%; padding: 0; margin: 0; border: none; }
            .no-print { display: none !important; }
            .page-break { page-break-before: always; }
            .bg-light { background-color: #f8f9fa !important; -webkit-print-color-adjust: exact; }
            .chart-col { min-width: 350px; }
            h5 { font-size: 1.1rem; margin-bottom: 10px !important; } 
        }
    </style>
</head>
<body>

<div class="container py-4 no-print">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h3 class="text-primary fw-bold mb-0">ğŸ¥ æ´»å‹•å ±å‘Šç”Ÿæˆå™¨ V14.0</h3>
            <small class="text-muted">æ–°å¢åŠŸèƒ½ï¼šæå– Excel æ•¸æ“šé€²è¡Œæ‰‹å‹•ä¿®æ­£</small>
        </div>
        <div class="text-end">
            <button class="btn btn-outline-primary me-2" onclick="saveProject()">ğŸ’¾ å„²å­˜å°ˆæ¡ˆ</button>
            <button class="btn btn-outline-secondary" onclick="document.getElementById('loadInput').click()">ğŸ“‚ è®€å–èˆŠæª”</button>
            <input type="file" id="loadInput" style="display:none" accept=".json" onchange="loadProject(this)">
        </div>
    </div>

    <div class="alert alert-warning border-warning d-flex align-items-center" role="alert">
        <span class="fs-4 me-2">ğŸ’¡</span>
        <div>
            <strong>æ–°åŠŸèƒ½æç¤ºï¼š</strong> å¦‚æœç™¼ç¾ Excel è®€å–çš„æ•¸æ“šæœ‰èª¤ï¼Œè«‹é¸æ“‡è©²æ¬„ä½å¾Œé»æ“Š <strong>ã€ŒğŸ“ æå–æ•¸æ“šä»¥ä¿®æ­£ã€</strong>ï¼Œç³»çµ±æœƒå°‡æ•¸æ“šè½‰æ›ç‚ºæ‰‹å‹•è¼¸å…¥æ¡†ï¼Œè®“æ‚¨è‡ªç”±ä¿®æ”¹ã€‚
        </div>
    </div>

    <div class="card border-primary">
        <div class="card-header bg-primary text-white">ğŸ“‚ æ­¥é©Ÿ 1ï¼šåŒ¯å…¥æ•¸æ“š (æ”¯æ´å¤šæª”)</div>
        <div class="card-body py-3">
            <div class="row align-items-center mb-3">
                <div class="col-md-8">
                    <label class="form-label fw-bold">Excel æ¨™é¡Œåˆ—è¨­å®šï¼š</label>
                    <div class="input-group">
                        <span class="input-group-text">é¡Œç›®åœ¨ç¬¬</span>
                        <input type="number" id="headerRowIndex" class="form-control" value="1" min="1" style="max-width: 80px;">
                        <span class="input-group-text">è¡Œ</span>
                    </div>
                </div>
            </div>
            <div class="upload-zone py-3" id="dropZone" onclick="document.getElementById('excelInput').click()">
                <h5 class="mb-1">é»æ“Šæˆ–æ¡†é¸å¤šå€‹ Excel æª”æ¡ˆ</h5>
                <div id="fileInfo" class="mt-1 text-success fw-bold small"></div>
            </div>
            <input type="file" id="excelInput" style="display:none" accept=".xlsx, .xls, .csv" multiple onchange="handleExcelUpload(this)">
        </div>
    </div>

    <div class="card">
        <div class="card-header">ğŸ“ æ­¥é©Ÿ 2ï¼šåŸºæœ¬è³‡æ–™</div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-7">
                    <label class="form-label fw-bold">å ±å‘ŠæŠ¬é ­</label>
                    <select id="hospitalHeader" class="form-select">
                        <option value="æ¸¯å³¶æ±é†«é™¢è¯ç¶²">æ¸¯å³¶æ±é†«é™¢è¯ç¶²</option>
                        <option value="æ±å€å°¤å¾·å¤«äººé‚£æ‰“ç´ é†«é™¢">æ±å€å°¤å¾·å¤«äººé‚£æ‰“ç´ é†«é™¢</option>
                        <option value="å¾‹æ•¦æ²»åŠé„§è‚‡å …é†«é™¢">å¾‹æ•¦æ²»åŠé„§è‚‡å …é†«é™¢</option>
                        <option value="é»ƒç«¹å‘é†«é™¢">é»ƒç«¹å‘é†«é™¢</option>
                        <option value="æ±è¯æ±é™¢">æ±è¯æ±é™¢</option>
                        <option value="é•·æ´²é†«é™¢">é•·æ´²é†«é™¢</option>
                        <option value="èˆ‚ç£¡è§’æ…ˆæ°è­·é¤Šé™¢">èˆ‚ç£¡è§’æ…ˆæ°è­·é¤Šé™¢</option>
                    </select>
                </div>
                <div class="col-md-5">
                    <label class="form-label fw-bold">æœå‹™å–®ä½</label>
                    <select id="serviceUnit" class="form-select">
                        <option value="ç—…äººè³‡æºä¸­å¿ƒ">ç—…äººè³‡æºä¸­å¿ƒ</option>
                        <option value="å¥åº·è³‡æºä¸­å¿ƒ">å¥åº·è³‡æºä¸­å¿ƒ</option>
                        <option value="é‚£æ‰“ç´ ç—…äººè³‡æºä¸­å¿ƒ">é‚£æ‰“ç´ ç—…äººè³‡æºä¸­å¿ƒ</option>
                        <option value="ç™Œç—‡ç—…äººè³‡æºä¸­å¿ƒ">ç™Œç—‡ç—…äººè³‡æºä¸­å¿ƒ</option>
                        <option value="ç²¾ç¥å¥åº·è³‡æºä¸­å¿ƒ">ç²¾ç¥å¥åº·è³‡æºä¸­å¿ƒ</option>
                    </select>
                </div>
                <div class="col-md-6"><label class="form-label">æ´»å‹•åç¨±</label><input type="text" id="actName" class="form-control"></div>
                <div class="col-md-6"><label class="form-label">è¨ªå•å°è±¡</label><input type="text" id="target" class="form-control"></div>
                <div class="col-md-4">
                    <label class="form-label">è¨ªå•æ—¥æœŸ</label>
                    <div class="input-group">
                        <input type="text" id="date" class="form-control" placeholder="æ‰‹å‹•æˆ–é¸å– ->">
                        <input type="date" class="form-control" style="max-width: 50px;" onchange="document.getElementById('date').value=this.value">
                    </div>
                </div>
                <div class="col-md-4"><label class="form-label">æ”¶å›æœ‰æ•ˆå•å·</label><input type="number" id="validQ" class="form-control bg-light" readonly></div>
                <div class="col-md-4"></div>
                
                <div class="col-12">
                    <div class="p-3 bg-light border rounded">
                        <label class="form-label fw-bold text-primary mb-2">ğŸ‘¥ å‡ºå¸­äººæ•¸ç´°é …</label>
                        <div class="row g-2">
                            <div class="col-md-3"><label class="small text-muted">ç—…äºº</label><input type="number" id="attPatients" class="form-control" placeholder="0"></div>
                            <div class="col-md-3"><label class="small text-muted">ç…§é¡§è€…</label><input type="number" id="attCarers" class="form-control" placeholder="0"></div>
                            <div class="col-md-3"><label class="small text-muted">ç¾©å·¥</label><input type="number" id="attVolunteers" class="form-control" placeholder="0"></div>
                            <div class="col-md-3"><label class="small text-muted">å…¶ä»–</label><input type="number" id="attOthers" class="form-control" placeholder="0"></div>
                        </div>
                    </div>
                </div>
                
                <div class="col-12"><hr class="my-2"></div>
                <div class="col-md-12">
                    <label class="form-label fw-bold text-primary">ğŸ¯ æ´»å‹•ç›®æ¨™</label>
                    <div class="row g-2">
                        <div class="col-md-4"><input type="text" id="goal1" class="form-control form-control-sm" placeholder="ç›®æ¨™ 1"></div>
                        <div class="col-md-4"><input type="text" id="goal2" class="form-control form-control-sm" placeholder="ç›®æ¨™ 2"></div>
                        <div class="col-md-4"><input type="text" id="goal3" class="form-control form-control-sm" placeholder="ç›®æ¨™ 3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>ğŸ“Š æ­¥é©Ÿ 3ï¼šç¬¬ä¸€éƒ¨åˆ† (é¸æ“‡é¡Œ/è©•åˆ†é¡Œ)</span>
            <button class="btn btn-sm btn-outline-primary" onclick="addQuestionRow()">+ å¢åŠ å•é¡Œ</button>
        </div>
        <div class="card-body" id="questionsContainer"></div>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>ğŸ’¬ æ­¥é©Ÿ 4ï¼šæ–‡å­—å›é¥‹</span>
            <button class="btn btn-sm btn-outline-primary" onclick="addTextSection()">+ å¢åŠ æ–‡å­—å€åŸŸ</button>
        </div>
        <div class="card-body" id="textSectionsContainer"></div>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>ğŸ’° æ­¥é©Ÿ 5ï¼šè²¡å‹™æ”¶æ”¯è¡¨</span>
            <div>
                <button class="btn btn-sm btn-outline-success me-1" onclick="addFinanceRow('income')">+ æ”¶å…¥</button>
                <button class="btn btn-sm btn-outline-danger" onclick="addFinanceRow('expense')">+ æ”¯å‡º</button>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 border-end"><h6 class="text-success fw-bold">æ”¶å…¥</h6><div id="incomeContainer"></div></div>
                <div class="col-md-6"><h6 class="text-danger fw-bold">æ”¯å‡º</h6><div id="expenseContainer"></div></div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">ğŸ“· æ­¥é©Ÿ 6ï¼šç¸½çµèˆ‡ç…§ç‰‡</div>
        <div class="card-body">
            <div class="mb-2"><label class="form-label">ç¸½çµå…§å®¹</label><textarea id="conclusionText" class="form-control" rows="3"></textarea></div>
            <div class="mb-2"><label class="form-label">ä¸Šè¼‰ç…§ç‰‡</label><input type="file" id="photoInput" class="form-control" multiple accept="image/*" onchange="previewPhotos()"><div id="inputPhotoPreview" class="d-flex flex-wrap mt-2"></div></div>
        </div>
    </div>

    <div class="d-grid gap-2 mb-5">
        <button class="btn btn-success btn-lg fw-bold" onclick="generateReport()">ğŸš€ ç”Ÿæˆå ±å‘Š</button>
    </div>
</div>

<div id="reportOutput" class="report-section container">
    <div class="text-center mb-4">
        <h2 id="outHeader" class="fw-bold mb-1"></h2>
        <h3 id="outUnit" class="fw-bold mb-2"></h3>
        <h4 id="outTitle" class="text-dark"></h4>
    </div>

    <table class="table table-bordered text-center align-middle mb-3 table-sm">
        <thead class="table-light"><tr><th width="25%">è¨ªå•å°è±¡</th><th width="25%">è¨ªå•æ—¥æœŸ</th><th width="25%">å‡ºå¸­äººæ•¸</th><th width="25%">æ”¶å›æœ‰æ•ˆå•å·</th></tr></thead>
        <tbody><tr><td id="outTarget"></td><td id="outDate"></td><td id="outAttendees"></td><td id="outValidQ" class="fw-bold"></td></tr></tbody>
    </table>

    <div class="mb-4">
        <h5 class="fw-bold bg-light ps-2 border-start border-4 border-primary py-1">å ±å‘Šä»‹ç´¹</h5>
        <div class="ps-2 small">
            <p class="mb-1"><strong>å•å·è¨­è¨ˆï¼š</strong>åˆ†ç‚ºé¸æ“‡é¡Œè©•åˆ†åŠæ–‡å­—å»ºè­°ã€‚</p>
            <div class="mt-2 border-top pt-2"><p class="mb-1 fw-bold text-decoration-underline">æ´»å‹•ç›®æ¨™ï¼š</p><ul id="outGoalsList" class="mb-0 ps-3"></ul></div>
        </div>
    </div>

    <div class="mb-4">
        <h5 class="fw-bold bg-light ps-2 border-start border-4 border-primary py-1">å•å·çµæœåˆ†æ (ç¬¬ä¸€éƒ¨åˆ†ï¼šé¸æ“‡é¡Œ)</h5>
        <div id="outChartsArea"></div>
    </div>

    <div class="page-break"></div>

    <div class="mb-4"><h5 class="fw-bold bg-light ps-2 border-start border-4 border-primary py-1">æ–‡å­—å›é¥‹</h5><div id="outTextSections"></div></div>
    <div id="outFinanceSection" class="mb-4"><h5 class="fw-bold bg-light ps-2 border-start border-4 border-primary py-1">è²¡å‹™å ±å‘Š</h5><div id="outFinanceTable"></div></div>
    <div class="mb-4"><h5 class="fw-bold bg-light ps-2 border-start border-4 border-primary py-1">ç¸½çµ</h5><div id="outConclusion" class="p-2 small" style="white-space: pre-wrap;"></div></div>
    <div id="photoSection" class="mb-4" style="display:none;"><h5 class="fw-bold bg-light ps-2 border-start border-4 border-primary py-1">æ´»å‹•ç…§ç‰‡</h5><div id="outPhotos" class="text-center mt-3 d-flex flex-wrap justify-content-center"></div></div>

    <div class="signature-box">
        <div class="mb-5"><span class="sig-label">æ’°å¯«å ±å‘Šç¤¾å·¥ï¼š</span><span class="sig-line"></span></div>
        <div class="mb-5"><div class="sig-label mb-2">éƒ¨é–€ä¸»ç®¡æ„è¦‹ï¼š</div><div class="comment-lines"></div><div class="comment-lines"></div></div>
        <div class="sig-row"><div><span class="sig-label">éƒ¨é–€ä¸»ç®¡ç°½ç½²ï¼š</span><span class="sig-line"></span></div><div><span class="sig-label">æ—¥æœŸï¼š</span><span class="sig-line" style="width: 150px;"></span></div></div>
    </div>

    <div class="text-center mt-5 no-print py-3 border-top">
        <button class="btn btn-secondary me-3" onclick="window.location.reload()">ğŸ”„ é‡æ–°é–‹å§‹</button>
        <button class="btn btn-primary btn-lg shadow" onclick="window.print()">ğŸ–¨ï¸ åˆ—å° / å¦å­˜ PDF</button>
    </div>
</div>

<script>
    let excelData = [];
    let excelHeaders = [];
    let questionCounter = 0;
    let textSectionCounter = 0;
    let uploadedImages = [];

    const originalTitle = document.title;
    window.onbeforeprint = function() { document.title = "æ´»å‹•å ±å‘Š"; };
    window.onafterprint = function() { document.title = originalTitle; };

    window.onload = function() {
        addQuestionRow();
        addTextSection("ç¬¬äºŒéƒ¨åˆ†ï¼šå—è¨ªè€…å°æ´»å‹•å…§å®¹çš„å»ºè­°");
        addTextSection("ç¬¬ä¸‰éƒ¨åˆ†ï¼šå—è¨ªè€…å°æ˜¯æ¬¡æ´»å‹•çš„å…¶ä»–æ„è¦‹");
        addFinanceRow('income');
        addFinanceRow('expense');
    };

    // --- Excel Handling ---
    async function handleExcelUpload(input) {
        const files = input.files;
        if (!files.length) return;
        document.getElementById('fileInfo').innerText = `æ­£åœ¨è™•ç† ${files.length} å€‹æª”æ¡ˆ...`;
        document.querySelector('.upload-zone').classList.add('active');
        const headerIndex = parseInt(document.getElementById('headerRowIndex').value) || 1;
        const range = headerIndex - 1;

        const readFile = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { defval: "", range: range });
                    resolve(json);
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        };

        try {
            const allFilesData = await Promise.all(Array.from(files).map(readFile));
            let mergedData = [];
            allFilesData.forEach(d => mergedData = mergedData.concat(d));
            excelData = mergedData;

            if(excelData.length > 0) {
                excelHeaders = Object.keys(excelData[0]).filter(k => k !== 'Timestamp' && k !== 'æ™‚é–“æˆ³è¨˜' && k !== '__EMPTY');
                document.getElementById('validQ').value = excelData.length;
                updateAllDropdowns();
                excelHeaders.forEach(h => { if(h.includes("æ—¥æœŸ")) try { document.getElementById('date').value = new Date(excelData[0][h]).toISOString().split('T')[0]; } catch(e){} });
                alert(`âœ… æˆåŠŸåˆä½µ ${files.length} å€‹æª”æ¡ˆï¼Œå…± ${excelData.length} ç­†æ•¸æ“š`);
            } else { alert("âš ï¸ è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¨™é¡Œè¡Œæ•¸è¨­å®š"); }
        } catch (err) { console.error(err); alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤"); }
    }

    function updateAllDropdowns() {
        const selectors = document.querySelectorAll('.excel-column-selector');
        selectors.forEach(sel => {
            const currentVal = sel.value;
            sel.innerHTML = '<option value="">-- é¸ Excel æ¬„ä½ --</option><option value="MANUAL_INPUT">âœï¸ æ‰‹å‹•è¼¸å…¥ (5åˆ†åˆ¶)</option><option value="CUSTOM_MANUAL">âœï¸ æ‰‹å‹•è¼¸å…¥ (è‡ªè¨‚é¸é …)</option>';
            excelHeaders.forEach(h => { const opt = document.createElement('option'); opt.value = h; opt.text = h; sel.appendChild(opt); });
            sel.value = currentVal; 
        });
    }

    // --- Dynamic DOM ---
    function addQuestionRow() {
        questionCounter++;
        const div = document.createElement('div');
        div.className = 'dynamic-card';
        div.id = `q-card-${questionCounter}`;
        // V14: Added Extraction Button
        div.innerHTML = `
            <div class="d-flex justify-content-between mb-2">
                <span class="fw-bold text-primary">Q${questionCounter}</span>
                <button class="btn btn-sm text-danger border-0 p-0" onclick="this.parentElement.parentElement.remove()">âœ•</button>
            </div>
            <input type="text" class="form-control form-control-sm mb-2 q-title" placeholder="è¼¸å…¥å•é¡Œæ¨™é¡Œ">
            <div class="input-group mb-2">
                <select class="form-select form-select-sm excel-column-selector question-source" onchange="toggleManualInput(this, ${questionCounter})">
                    <option value="">-- é¸ Excel æ¬„ä½ --</option><option value="MANUAL_INPUT">âœï¸ æ‰‹å‹•è¼¸å…¥ (5åˆ†åˆ¶)</option><option value="CUSTOM_MANUAL">âœï¸ æ‰‹å‹•è¼¸å…¥ (è‡ªè¨‚é¸é …)</option>
                </select>
                <button class="btn btn-outline-success btn-sm" type="button" onclick="extractDataToManual(${questionCounter})" title="å¾é¸å–çš„ Excel æ¬„ä½è®€å–æ•¸æ“šä¸¦å¡«å…¥ä¸‹æ–¹ä¿®æ­£">ğŸ“ æå–æ•¸æ“šä»¥ä¿®æ­£</button>
            </div>
            
            <div id="manual-inputs-${questionCounter}" class="manual-inputs row g-1">
                <div class="col"><input type="number" class="form-control form-control-sm q-val" placeholder="éå¸¸åŒæ„"></div>
                <div class="col"><input type="number" class="form-control form-control-sm q-val" placeholder="åŒæ„"></div>
                <div class="col"><input type="number" class="form-control form-control-sm q-val" placeholder="ä¸€èˆ¬"></div>
                <div class="col"><input type="number" class="form-control form-control-sm q-val" placeholder="ä¸åŒæ„"></div>
                <div class="col"><input type="number" class="form-control form-control-sm q-val" placeholder="éå¸¸ä¸åŒæ„"></div>
            </div>

            <div id="custom-inputs-${questionCounter}" class="manual-inputs">
                <div class="custom-options-container"></div>
                <button class="btn btn-sm btn-outline-secondary mt-2" onclick="addCustomOption(${questionCounter})">+ æ–°å¢é¸é …</button>
            </div>
        `;
        document.getElementById('questionsContainer').appendChild(div);
        if(excelHeaders.length>0) updateAllDropdowns();
    }

    function addCustomOption(qId, label="", val="") {
        const container = document.querySelector(`#custom-inputs-${qId} .custom-options-container`);
        const row = document.createElement('div');
        row.className = 'custom-option-row';
        row.innerHTML = `
            <input type="text" class="form-control form-control-sm cust-opt-label" value="${label}" placeholder="é¸é …åç¨±">
            <input type="number" class="form-control form-control-sm cust-opt-val" value="${val}" placeholder="äººæ•¸" style="width: 80px;">
            <button class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove()">âœ•</button>
        `;
        container.appendChild(row);
    }

    // --- V14 New Function: Extract Data ---
    function extractDataToManual(qId) {
        const card = document.getElementById(`q-card-${qId}`);
        const sourceSelect = card.querySelector('.question-source');
        const colName = sourceSelect.value;

        if (!colName || colName === 'MANUAL_INPUT' || colName === 'CUSTOM_MANUAL') {
            alert("è«‹å…ˆé¸æ“‡ä¸€å€‹ Excel æ¬„ä½ï¼Œå†é»æ“Šæå–ã€‚");
            return;
        }
        if (excelData.length === 0) {
            alert("è«‹å…ˆä¸Šè¼‰ Excel æª”æ¡ˆã€‚");
            return;
        }

        // Count data
        const counts = {};
        excelData.forEach(row => {
            let val = String(row[colName] || "").trim();
            if(val) counts[val] = (counts[val] || 0) + 1;
        });

        if (Object.keys(counts).length === 0) {
            alert("è©²æ¬„ä½æ²’æœ‰æ•¸æ“šã€‚");
            return;
        }

        // Switch to Custom Manual Mode
        sourceSelect.value = 'CUSTOM_MANUAL';
        toggleManualInput(sourceSelect, qId);

        // Clear existing custom options
        const container = card.querySelector(`#custom-inputs-${qId} .custom-options-container`);
        container.innerHTML = '';

        // Fill with extracted data
        for (const [label, count] of Object.entries(counts)) {
            addCustomOption(qId, label, count);
        }
        
        // Auto fill title if empty
        const titleInput = card.querySelector('.q-title');
        if (!titleInput.value) titleInput.value = colName;

        alert("æ•¸æ“šå·²æå–ï¼æ‚¨ç¾åœ¨å¯ä»¥åœ¨ä¸‹æ–¹æ‰‹å‹•ä¿®æ”¹æ•¸æ“šã€‚");
    }

    function toggleManualInput(sel, id) {
        const manualDiv = document.getElementById(`manual-inputs-${id}`);
        const customDiv = document.getElementById(`custom-inputs-${id}`);
        
        manualDiv.style.display = sel.value === 'MANUAL_INPUT' ? 'flex' : 'none';
        customDiv.style.display = sel.value === 'CUSTOM_MANUAL' ? 'block' : 'none';
        
        if(sel.value && !sel.value.includes('MANUAL')) {
            const row = sel.closest('.dynamic-card');
            const ti = row.querySelector('.q-title');
            if(ti && !ti.value) ti.value = sel.value;
        }
    }

    function addTextSection(title="") {
        textSectionCounter++;
        const div = document.createElement('div');
        div.className = 'dynamic-card';
        div.innerHTML = `
            <div class="d-flex justify-content-between mb-2">
                <input type="text" class="form-control form-control-sm me-2 text-title fw-bold" value="${title}" placeholder="æ¨™é¡Œ">
                <button class="btn btn-sm text-danger border-0 p-0" onclick="this.parentElement.parentElement.remove()">âœ•</button>
            </div>
            <select class="form-select form-select-sm excel-column-selector text-source mb-2" onchange="toggleTextManual(this, 'manual-text-${textSectionCounter}')">
                <option value="">-- é¸ Excel æ¬„ä½ --</option><option value="MANUAL_INPUT">âœï¸ æ‰‹å‹•è¼¸å…¥</option>
            </select>
            <div id="manual-text-${textSectionCounter}" class="manual-inputs">
                <textarea class="form-control text-manual-val" rows="3" placeholder="æ‰‹å‹•å…§å®¹..."></textarea>
            </div>`;
        document.getElementById('textSectionsContainer').appendChild(div);
        if(excelHeaders.length>0) updateAllDropdowns();
    }

    function toggleTextManual(sel, id) {
        document.getElementById(id).style.display = sel.value === 'MANUAL_INPUT' ? 'block' : 'none';
    }

    function addFinanceRow(type) {
        const div = document.createElement('div');
        div.className = 'input-group input-group-sm mb-1';
        div.innerHTML = `<input type="text" class="form-control fin-item-${type === 'income' ? 'inc' : 'exp'}" placeholder="é …ç›®"><input type="number" class="form-control fin-amount-${type === 'income' ? 'inc' : 'exp'}" placeholder="$"><button class="btn btn-outline-secondary" onclick="this.parentElement.remove()">âœ•</button>`;
        document.getElementById(type === 'income' ? 'incomeContainer' : 'expenseContainer').appendChild(div);
    }

    function previewPhotos() {
        const input = document.getElementById('photoInput');
        uploadedImages = [];
        document.getElementById('inputPhotoPreview').innerHTML = '';
        if(input.files) {
            Array.from(input.files).forEach(f => {
                const r = new FileReader();
                r.onload = e => {
                    uploadedImages.push(e.target.result);
                    const img = document.createElement('img'); img.src = e.target.result; img.className = 'photo-preview';
                    document.getElementById('inputPhotoPreview').appendChild(img);
                };
                r.readAsDataURL(f);
            });
        }
    }

    // --- SAVE / LOAD ---
    function saveProject() {
        const data = {
            header: document.getElementById('hospitalHeader').value,
            unit: document.getElementById('serviceUnit').value,
            actName: document.getElementById('actName').value,
            target: document.getElementById('target').value,
            date: document.getElementById('date').value,
            attPatients: document.getElementById('attPatients').value,
            attCarers: document.getElementById('attCarers').value,
            attVolunteers: document.getElementById('attVolunteers').value,
            attOthers: document.getElementById('attOthers').value,
            validQ: document.getElementById('validQ').value,
            goals: [document.getElementById('goal1').value, document.getElementById('goal2').value, document.getElementById('goal3').value],
            conclusion: document.getElementById('conclusionText').value,
            questions: [], textSections: [], finIncome: [], finExpense: [],
            excelData: excelData, images: uploadedImages
        };

        document.querySelectorAll('#questionsContainer .dynamic-card').forEach((card, idx) => {
            let manualData = [], customData = [];
            const source = card.querySelector('.question-source').value;
            
            if(source === 'MANUAL_INPUT') {
                const inputs = card.querySelectorAll(`#manual-inputs-${idx+1} .q-val`);
                manualData = Array.from(inputs).map(i => i.value);
            } else if (source === 'CUSTOM_MANUAL') {
                const rows = card.querySelectorAll('.custom-option-row');
                rows.forEach(r => customData.push({ label: r.querySelector('.cust-opt-label').value, val: r.querySelector('.cust-opt-val').value }));
            }

            data.questions.push({
                title: card.querySelector('.q-title').value,
                source: source,
                manualData: manualData,
                customData: customData
            });
        });

        // (Save Texts, Finance same as before)
        document.querySelectorAll('#textSectionsContainer .dynamic-card').forEach(card => {
            data.textSections.push({ title: card.querySelector('.text-title').value, source: card.querySelector('.text-source').value, manualVal: card.querySelector('.text-manual-val').value });
        });
        document.querySelectorAll('#incomeContainer .input-group').forEach(r => data.finIncome.push({ item: r.querySelector('.fin-item-inc').value, amount: r.querySelector('.fin-amount-inc').value }));
        document.querySelectorAll('#expenseContainer .input-group').forEach(r => data.finExpense.push({ item: r.querySelector('.fin-item-exp').value, amount: r.querySelector('.fin-amount-exp').value }));

        const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Project.json`; a.click();
    }

    function loadProject(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                // Restore basic fields
                document.getElementById('hospitalHeader').value = data.header;
                document.getElementById('serviceUnit').value = data.unit;
                document.getElementById('actName').value = data.actName;
                document.getElementById('target').value = data.target;
                document.getElementById('date').value = data.date;
                document.getElementById('attPatients').value = data.attPatients || "";
                document.getElementById('attCarers').value = data.attCarers || "";
                document.getElementById('attVolunteers').value = data.attVolunteers || "";
                document.getElementById('attOthers').value = data.attOthers || "";
                document.getElementById('validQ').value = data.validQ;
                document.getElementById('goal1').value = data.goals[0];
                document.getElementById('goal2').value = data.goals[1];
                document.getElementById('goal3').value = data.goals[2];
                document.getElementById('conclusionText').value = data.conclusion;
                if(data.excelData) { excelData = data.excelData; excelHeaders = Object.keys(excelData[0]).filter(k=>k!=='Timestamp'); }
                
                // Restore Questions
                document.getElementById('questionsContainer').innerHTML = '';
                questionCounter = 0;
                data.questions.forEach(q => {
                    addQuestionRow();
                    const card = document.getElementById(`q-card-${questionCounter}`);
                    card.querySelector('.q-title').value = q.title;
                    const sel = card.querySelector('.question-source');
                    sel.innerHTML = '<option value="">-- é¸ Excel æ¬„ä½ --</option><option value="MANUAL_INPUT">âœï¸ æ‰‹å‹•è¼¸å…¥ (5åˆ†åˆ¶)</option><option value="CUSTOM_MANUAL">âœï¸ æ‰‹å‹•è¼¸å…¥ (è‡ªè¨‚é¸é …)</option>';
                    excelHeaders.forEach(h => { const opt = document.createElement('option'); opt.value = h; opt.text = h; sel.appendChild(opt); });
                    sel.value = q.source;
                    toggleManualInput(sel, questionCounter); 
                    
                    if(q.source === 'MANUAL_INPUT') {
                        const inputs = card.querySelectorAll('.q-val');
                        q.manualData.forEach((v, i) => inputs[i].value = v);
                    } else if (q.source === 'CUSTOM_MANUAL' && q.customData) {
                        // Restore custom options
                        const container = card.querySelector('.custom-options-container');
                        container.innerHTML = ''; // clear default
                        q.customData.forEach(opt => {
                            addCustomOption(questionCounter, opt.label, opt.val);
                        });
                    }
                });

                // Restore others (Text, Finance, Photos)
                document.getElementById('textSectionsContainer').innerHTML = '';
                textSectionCounter = 0;
                data.textSections.forEach(t => { addTextSection(t.title); 
                    const cards = document.querySelectorAll('#textSectionsContainer .dynamic-card');
                    const card = cards[cards.length-1];
                    const sel = card.querySelector('.text-source');
                    sel.innerHTML = '<option value="">-- é¸ Excel æ¬„ä½ --</option><option value="MANUAL_INPUT">âœï¸ æ‰‹å‹•è¼¸å…¥</option>';
                    excelHeaders.forEach(h => { const opt = document.createElement('option'); opt.value = h; opt.text = h; sel.appendChild(opt); });
                    sel.value = t.source;
                    toggleTextManual(sel, card.querySelector('.manual-inputs').id);
                    card.querySelector('.text-manual-val').value = t.manualVal;
                });

                document.getElementById('incomeContainer').innerHTML = '';
                document.getElementById('expenseContainer').innerHTML = '';
                data.finIncome.forEach(f => { addFinanceRow('income'); const r = document.querySelectorAll('#incomeContainer .input-group'); r[r.length-1].querySelector('input[type=text]').value = f.item; r[r.length-1].querySelector('input[type=number]').value = f.amount; });
                data.finExpense.forEach(f => { addFinanceRow('expense'); const r = document.querySelectorAll('#expenseContainer .input-group'); r[r.length-1].querySelector('input[type=text]').value = f.item; r[r.length-1].querySelector('input[type=number]').value = f.amount; });
                
                uploadedImages = data.images || [];
                const pDiv = document.getElementById('inputPhotoPreview'); pDiv.innerHTML = ''; uploadedImages.forEach(s => pDiv.innerHTML += `<img src="${s}" class="photo-preview">`);

                alert("âœ… å°ˆæ¡ˆè®€å–æˆåŠŸ");
            } catch(e) { console.error(e); alert("è®€å–éŒ¯èª¤"); }
        };
        reader.readAsText(file);
    }

    // --- 3. GENERATE REPORT ---
    function generateReport() {
        document.getElementById('outHeader').innerText = document.getElementById('hospitalHeader').value;
        document.getElementById('outUnit').innerText = document.getElementById('serviceUnit').value;
        document.getElementById('outTitle').innerText = document.getElementById('actName').value + " - æ´»å‹•å ±å‘Š";
        document.getElementById('outTarget').innerText = document.getElementById('target').value;
        document.getElementById('outDate').innerText = document.getElementById('date').value;
        
        const p = parseInt(document.getElementById('attPatients').value)||0, c = parseInt(document.getElementById('attCarers').value)||0, v = parseInt(document.getElementById('attVolunteers').value)||0, o = parseInt(document.getElementById('attOthers').value)||0;
        let dArr = []; if(p>0) dArr.push(`ç—…äºº: ${p}`); if(c>0) dArr.push(`ç…§é¡§è€…: ${c}`); if(v>0) dArr.push(`ç¾©å·¥: ${v}`); if(o>0) dArr.push(`å…¶ä»–: ${o}`);
        document.getElementById('outAttendees').innerHTML = `<div class="fw-bold fs-5">${p+c+v+o}</div><div class="small text-muted" style="line-height:1.2; margin-top:4px;">${dArr.length > 0 ? `(${dArr.join(', ')})` : ""}</div>`;
        document.getElementById('outValidQ').innerText = document.getElementById('validQ').value;
        document.getElementById('outConclusion').innerText = document.getElementById('conclusionText').value;
        const goalsList = document.getElementById('outGoalsList'); goalsList.innerHTML = '';
        ['goal1', 'goal2', 'goal3'].forEach(id => { const val = document.getElementById(id).value; if(val) goalsList.innerHTML += `<li>${val}</li>`; });

        // --- CHARTS (V14.0 Logic) ---
        const chartsArea = document.getElementById('outChartsArea');
        chartsArea.innerHTML = '';
        const qCards = document.querySelectorAll('#questionsContainer .dynamic-card');

        qCards.forEach((card, index) => {
            const title = card.querySelector('.q-title').value;
            const source = card.querySelector('.question-source').value;
            
            const stdColors = ['#198754', '#20c997', '#ffc107', '#fd7e14', '#dc3545']; 
            const dynColors = ['#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#dc3545', '#fd7e14', '#ffc107', '#198754', '#20c997', '#0dcaf0'];

            let chartDataPoints = [];
            let total = 0;

            if (source === 'MANUAL_INPUT') {
                const inputs = card.querySelectorAll(`#manual-inputs-${index+1} .q-val`);
                const vals = Array.from(inputs).map(i => parseInt(i.value) || 0);
                const labels = ['éå¸¸åŒæ„', 'åŒæ„', 'ä¸€èˆ¬', 'ä¸åŒæ„', 'éå¸¸ä¸åŒæ„'];
                vals.forEach((v, i) => { if(v>0) { chartDataPoints.push({ name: labels[i], y: v, color: stdColors[i] }); total += v; } });
            
            } else if (source === 'CUSTOM_MANUAL') {
                // *** V14 Custom Logic with Smart Colors ***
                const rows = card.querySelectorAll('.custom-option-row');
                let cIndex = 0;
                rows.forEach(r => {
                    const label = r.querySelector('.cust-opt-label').value;
                    const val = parseInt(r.querySelector('.cust-opt-val').value) || 0;
                    
                    if (label && val > 0) {
                        // Check if label matches standard terms for specific coloring
                        let color = dynColors[cIndex % dynColors.length];
                        if(label.includes('éå¸¸åŒæ„')) color = stdColors[0];
                        else if(label.includes('åŒæ„')) color = stdColors[1];
                        else if(label.includes('ä¸€èˆ¬')) color = stdColors[2];
                        else if(label.includes('ä¸åŒæ„')) color = stdColors[3];
                        else if(label.includes('éå¸¸ä¸åŒæ„')) color = stdColors[4];
                        
                        chartDataPoints.push({ name: label, y: val, color: color });
                        total += val;
                        cIndex++;
                    }
                });

            } else if (source && excelData.length > 0) {
                // Auto Excel Mode
                const counts = {};
                excelData.forEach(row => {
                    let val = String(row[source] || "").trim();
                    if(val) { counts[val] = (counts[val] || 0) + 1; total++; }
                });
                const keys = Object.keys(counts);
                const isStandard = keys.some(k => k.includes("åŒæ„") || k.includes("Agree") || k === "5");

                if (isStandard) {
                    const stdMap = [
                        { keys: ["éå¸¸åŒæ„", "ååˆ†åŒæ„", "Strongly Agree", "5"], label: "éå¸¸åŒæ„", color: stdColors[0] },
                        { keys: ["åŒæ„", "Agree", "4"], label: "åŒæ„", color: stdColors[1] },
                        { keys: ["ä¸€èˆ¬", "Neutral", "3"], label: "ä¸€èˆ¬", color: stdColors[2] },
                        { keys: ["ä¸åŒæ„", "Disagree", "2"], label: "ä¸åŒæ„", color: stdColors[3] },
                        { keys: ["éå¸¸ä¸åŒæ„", "ååˆ†ä¸åŒæ„", "Strongly Disagree", "1"], label: "éå¸¸ä¸åŒæ„", color: stdColors[4] }
                    ];
                    stdMap.forEach(map => {
                        let count = 0;
                        keys.forEach(k => { if(map.keys.some(mk => k.includes(mk))) count += counts[k]; });
                        if(count > 0) chartDataPoints.push({ name: map.label, y: count, color: map.color });
                    });
                } else {
                    let cIndex = 0;
                    for (const [key, val] of Object.entries(counts)) {
                        chartDataPoints.push({ name: key, y: val, color: dynColors[cIndex % dynColors.length] });
                        cIndex++;
                    }
                    chartDataPoints.sort((a, b) => b.y - a.y);
                }
            } else return; 

            // Render Chart
            const chartId = `chart-container-${index}`;
            let tableHtml = `<table class="stats-table"><thead><tr><th>é¸é …</th><th>äººæ•¸</th><th>ç™¾åˆ†æ¯”</th></tr></thead><tbody>`;
            chartDataPoints.forEach(pt => {
                const pct = total > 0 ? ((pt.y / total) * 100).toFixed(1) : "0.0";
                tableHtml += `<tr><td>${pt.name}</td><td>${pt.y}</td><td>${pct}%</td></tr>`;
            });
            tableHtml += `</tbody></table>`;

            const wrapper = document.createElement('div');
            wrapper.className = 'chart-row';
            wrapper.innerHTML = `<div class="w-100"><h6 class="fw-bold mb-2">Q${index+1}. ${title}</h6><div class="d-flex align-items-center"><div class="chart-col"><div id="${chartId}" class="chart-container"></div></div><div class="table-col">${tableHtml}</div></div></div>`;
            chartsArea.appendChild(wrapper);

            Highcharts.chart(chartId, {
                chart: { type: 'pie', backgroundColor: null, animation: false },
                title: { text: null },
                plotOptions: {
                    pie: {
                        innerSize: 50,
                        dataLabels: {
                            enabled: true, distance: 5,
                            formatter: function() { return this.y > 0 ? `<b>${this.point.name}</b>:<br>${this.y} (${this.percentage.toFixed(1)}%)` : null; },
                            style: { fontSize: '9px', color: 'black', textOutline: 'none' }, connectorPadding: 2
                        },
                        showInLegend: true
                    }
                },
                legend: { enabled: false }, // V14: Keep legend off as requested
                series: [{ name: 'äººæ•¸', data: chartDataPoints }],
                credits: { enabled: false }
            });
        });

        renderTextAndFinance();
    }

    function renderTextAndFinance() {
        const textContainer = document.getElementById('outTextSections'); textContainer.innerHTML = '';
        document.querySelectorAll('#textSectionsContainer .dynamic-card').forEach(card => {
            const title = card.querySelector('.text-title').value; const source = card.querySelector('.text-source').value;
            let html = '';
            if (source === 'MANUAL_INPUT') html = card.querySelector('.text-manual-val').value ? `<p style="white-space: pre-wrap;">${card.querySelector('.text-manual-val').value}</p>` : "<p class='text-muted'>ç„¡å…§å®¹</p>";
            else if (source && excelData.length) { let ul=""; excelData.forEach(r=>{if(r[source]) ul+=`<li class="mb-1 border-bottom pb-1">â€¢ ${r[source]}</li>`}); html = ul?`<ul class="list-unstyled mb-0">${ul}</ul>`:"ç„¡å…§å®¹"; }
            textContainer.innerHTML += `<div class="mt-3"><p class="fw-bold mb-1">${title}</p><div class="p-2 bg-light border rounded small">${html}</div></div>`;
        });

        const finSection = document.getElementById('outFinanceSection');
        let incomeHtml = '', expenseHtml = '', totalInc = 0, totalExp = 0, hasItem = false;
        document.querySelectorAll('#incomeContainer .input-group').forEach(r => { const i = r.querySelector('input[type=text]').value, a = parseFloat(r.querySelector('input[type=number]').value)||0; if(i||a){ hasItem=true; totalInc+=a; incomeHtml+=`<tr><td>${i}</td><td class="fin-amount">$${a.toFixed(2)}</td></tr>`; }});
        document.querySelectorAll('#expenseContainer .input-group').forEach(r => { const i = r.querySelector('input[type=text]').value, a = parseFloat(r.querySelector('input[type=number]').value)||0; if(i||a){ hasItem=true; totalExp+=a; expenseHtml+=`<tr><td>${i}</td><td class="fin-amount">$${a.toFixed(2)}</td></tr>`; }});
        
        if(!hasItem && totalInc===0 && totalExp===0) finSection.style.display = 'none';
        else {
            finSection.style.display = 'block';
            document.getElementById('outFinanceTable').innerHTML = `<table class="fin-table"><thead><tr><th width="50%">æ”¶å…¥</th><th width="50%">æ”¯å‡º</th></tr></thead><tbody><tr valign="top"><td style="padding:0"><table class="w-100" style="border:none">${incomeHtml}<tr class="fin-total-row"><td>ç¸½æ”¶å…¥</td><td class="fin-amount">$${totalInc.toFixed(2)}</td></tr></table></td><td style="padding:0"><table class="w-100" style="border:none">${expenseHtml}<tr class="fin-total-row"><td>ç¸½æ”¯å‡º</td><td class="fin-amount">$${totalExp.toFixed(2)}</td></tr></table></td></tr></tbody></table><div class="text-end fw-bold border p-2 bg-light">ç›ˆé¤˜: <span class="${(totalInc-totalExp)>=0?'text-success':'text-danger'}">$${(totalInc-totalExp).toFixed(2)}</span></div>`;
        }

        const outPhotos = document.getElementById('outPhotos'); outPhotos.innerHTML = '';
        if(uploadedImages.length) { document.getElementById('photoSection').style.display='block'; uploadedImages.forEach(src => outPhotos.innerHTML+=`<img src="${src}" class="photo-preview">`); }
        else document.getElementById('photoSection').style.display='none';

        document.getElementById('reportOutput').style.display = 'block';
        setTimeout(() => window.scrollTo(0, document.getElementById('reportOutput').offsetTop), 100);
    }
</script>

</body>
</html>
